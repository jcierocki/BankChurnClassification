---
output:
  pdf_document:
    includes:
      in_header: "preamble.tex"
---

```{r, include=FALSE}

library(tidyverse)
library(stringr)
library(scorecard)
library(tidymodels)
library(ranger)
library(xgboost)
library(vip)
library(knitr)
library(rpart)
library(rpart.plot)

rm(list = ls())

source("../funs_valid.R")
source("../funs_preproc.R")

tree_model_full <- read_rds("../data/tree_model1.rds")
tree_model_simple <- read_rds("../data/tree_model2.rds")
ranger_models <- read_rds("../data/fitted_models.RDS")
xgboost_model <- read_rds("../data/fitted_xgboost.RDS")
# df_preds_ranger <- read_rds("../data/predictions.RDS")
# df_pred_xgboost <- read_rds("../data/predictions_xgboost.RDS")
df_1 <- read_rds("../data/split.RDS")
df_2 <- read_rds("../data/split_raw.RDS")

models <- list(tree = tree_model_full, forest1 = ranger_models$model_1[[1]], 
            forest2 = ranger_models$model_2[[1]], gbm = xgboost_model)

test_dfs <- list(tree = df_2, forest1 = df_1, forest2 = df_2, gbm = df_1) %>% map(~ testing(.x))

test_dfs$gbm <- test_dfs$gbm %>%
  mutate_if(~ length(levels(.x)) > 2, as.integer) %>%
  mutate_at(vars(Balance), as.integer)

spec_names <- c("Drzewo", "Las (uproszczone)", "Las (surowe)", "XGBoost")

predict_dfs <- predict_and_bind(models, test_dfs, spec_names)

```

\begin{titlepage}

\begin{center}
\vspace*{0.5in}
\begin{figure}[htb]
\begin{center}
\includegraphics[width=7cm]{herbSGH.png}
\end{center}
\end{figure}
\vspace*{0.15in}
Indukowane Reguły Decyzyjne - 2020\\
\vspace*{0.05in}
SGH Warsaw School of Economics \\
\vspace*{0.5in}
\begin{large}
CHURN MODELLING \\
\end{large}
\vspace*{0.2in}
\begin{Large}
\textbf{Klasyfikacja klienta banku} \\
\end{Large}
\vspace*{0.5in}
\rule{80mm}{0.1mm}\\
\vspace*{0.1in}
\begin{large}
Przygotowane przez: \\
Jakub Cierocki \& Szymon Reddig \\
\end{large}
\end{center}
\end{titlepage}

\clearpage
\tableofcontents
\clearpage

## Wprowadzenie

Zjawisko tzw. ,,customer churn'' (ang. \textit{churn} - odpływ, rezygnacja), czyli rezygnacji klienta z subskrypcji usług danego przedsiębiorstwa, jest w kręgu zainteresowania naukowców od wielu lat.

Do modelowania churnu stosuje się m.in. metody analizy przetrwania (jak długo klient będzie odnawiał subskrybcję) oraz klasyfikacji binarnej (czy klient w niedługiej przyszłości zmieni dostawcę usług). W niniejszym raporcie zajmiemy się drugim z ww. zagadnień.

Firmy, a w szczególności telekomy, ubezpieczyciele oraz banki, inwestują w modelowanie tego zjawiska, gdyż pozyskiwanie nowych klientów jest często o wiele droższym zabiegiem, niż utrzymanie dotychczasowych, a dynamika ich liczby jest kluczowa przy modelowaniu procesów biznesowych. Przykładowo, jeśli Spotify (dostawca usługi streamowania muzyki) zidentyfikowałoby segment osób, które z dużym prawdopobieństwem zrezygnują niedługo z subskrypcji, przedsiębiorstwo mogłoby zasypać ich specjalnymi ofertami, zachęcających ich do dalszego korzystania z ich oferty. Z drugiej strony powiązanie nielojalności konsumenckiej z atrybutami konkretnej podgrupy klientów może pomóc w racjonalizacji kosztów przeznaczonych na reklamę i projektowanie produktów przeznaczonych dla jej przedstawicieli. W przypadku m.in. telekomów subskrypcje abonamentowe stanowią podstawowe źródło dochodów przedsiębiorstwa i ich odpowiednie prognozowanie ich dynamiki jest niezbędne w procesie prognozowania przychodów przedsiębiorstwa.

## Problem badawczy

Zjawisko ,,churnu'' będzie analizowane z perspektywy banku. Dysponuje on pewnymi danymi personalnymi swoich klientów oraz pełną informacją o ich aktualnej (i przeszłej) subskrypcji usług tego banku. Celem niniejszej pracy będzie zbadanie czy na podstawie tych danych bank jest w stanie przewidzieć przyszłe decyzje o rezygnacji z jego usług w niedalekiej (bliżej nie określonej) przyszłości.

## Zbiór danych

Zbiór danych wykorzystamy w niniejszej pochodzi z portalu kaggle.com, należącego do Google LLC i pełniącego rolę platformy wymiany myśli (w tym zbiorów danych) dla specjalistów i pasjonatów zajmujących się analizą danych. Zanonimizowane dane dotyczą 10 tys. klientów jednego z banków, operującego w 3 różnych krajach (Francja, Niemcy, Hiszpania).

Rolę atrybutu decyzyjnego będzie pełnić zmiennna binarna \textit{EXIT}, która przyjmuje wartość 1 jeżeli klient zrezygnował z usług danego banku. Odsetek klientów, którzy zmienili dostawcę usług bankowych wynosi w analizowanym zbiorze 20,37\%.

Wykorzystany zbiór deskryptorów liczy łącznie 10 zmiennych, które opisują cechy osobowe oraz historię relacji danego klienta z bankiem.

\begin{itemize}
  \item \textit{Geography} - kraj pochodzenia, zmienna kategoryzowana, skala nominalna
  \item \textit{Gender} - płeć, zmienna binarna, 1 - mężczyzna
  \item \textit{HasCrCard} - posiadanie karty kredytowej, zmienna binarna, 1 - posiada
  \item \textit{IsActiveMember} - bycie aktywnym klientem banku (korzystającym z subskrybowanych usług np. wykonującym przelewy), zmienna binarna, 1 - tak
  \item \textit{Age} - wiek, zmienna całkowitoliczbowa
  \item \textit{Balance} - ilość pieniędzy na koncie, zmienna liczbowa
  \item \textit{CreditScore} - ocena wiarygodności kredytowej, zmienna liczbowa
  \item \textit{NumOfProducts} - liczba subsrybowanych usług bankowych, zmienna całkowitoliczbowa
  \item \textit{EstimatedSalary} - przybliżone zarobki, zmienna liczbowa
  \item \textit{Tenure} - liczba lat odkąd klient zaczął korzystać z usług danego banku, zmienna całkowitoliczbowa
\end{itemize}

Surowy zbiór danych był już oczyszony i nie zawierał braków danych oraz zmiennych wymagających rekodowania. Dokonano konwersji typów na odpowiadające rzeczywistemu charakterowi zmiennych (liczbowe lub kategoryzowane). Kategoriom zmiennych jakościowych nadano odpowiednie etykiety. Zmienna \textit{Country} jako jedyna zmienna nominalna z liczbą kategorii $>2$ w zbiorze została przekonwertowana na dwie zmienne binarne \textit{CountryGermany} oraz \textit{CountrySpain}.

Zostały wyodrębione 2 warianty zbioru danych. Pierwszy, który dalej będzie nazywany surowym, zawiera dane uwzględniające tylko ww. przekształcenia. Drugi, które będzie dalej nazywany przekształconym, zawiera wszystkie zmienne ilościowe poddane kategoryzacji. Wykorzystano w tym celu pakiet \textit{scorecard} oraz algorytm wykorzystujące drzewa do dobrania optymalnego z punktu widzenia IV (ang. \textit{Information Value}) kategoryzacji zmiennej. W celu uniknięcia zaburzenia oceny istotności zmiennych w modelu na podstawie wskaźnika Giniego, maksymalna liczba kategorii została ustalona na poziomie 5. Już po konwersji, uzyskany zbiór danych przefiltrowano adrzucając zmienne, których IV było mniejsze od 0.01.

```{r, echo=FALSE}
get_all_iv(df_1$data, df_2$data) %>% 
  mutate_if(is.numeric, ~ round(.x, 2)) %>% 
  kable("markdown", col.names = c("Zmienna", "Surowy", "Przekształcony"))
```

IV są konsekwentnie wyższe dla danych nieprzekształconych, co wynika z faktu, że wskaźnik ten jest dodatnio skorelowany z liczbą kategorii. 

```{r, echo=FALSE, out.height='310px', fig.align='center'}
plot_multi_freq(df_1$data, c("Age", "Balance", "NumOfProducts"))
```

Jak widać na powyższym wykresie są obserwowane liniowe zależności między udziałem danej kategorii w liczbie obserwacji, a procentem rezygnujących klientów, dla zmiennych \textit{Balance} oraz \textit{NumOfProducts}. W przypadku zmiennej \textit{Age} wykres nie sugeruje takiej korelacji co budzi podejrzenia co do poprawności tej kategoryzacji.

## Metodologia

W pracy zostaną porównane 4 modele:
\begin{itemize}
  \item drzewo decyzyjne CART na danych surowych (pakiet \textit{rpart})
  \item las losowy na danych przekształconych (pakiet \textit{ranger})
  \item las losowy na danych surownych (pakiet \textit{ranger})
  \item GBM na danych przekształconych (pakiet \textit{XGBoost})
\end{itemize}

Drzewo decyzyjne na danych przekształconych pominięto ponieważ kategoryzacja zmiennych służy jedynie możliwości uzyskania nieobciążonych pomiarów istotności obliczanych z użyciem wskaźnika Giniego, a w przypadku pojedynczego drzewa mamy możliwość jego podejrzenia i co za tym idzie pełną interpretowalność zmiennych. GBM na danych surowych pominięto ponieważ API pakietu XGBoost nie pozwala na oszacowanie istotności zmiennych metodą permutacyjną przy trenowaniu modelu. W tej sytuacji, zastosowanie danych surowych spowodowałoby uzyskanie obciążonych pomiarów istotności zmiennych.

Do zarządzania podziałem zbiorów na testowy i uczący, określania specyfikacji, trenowania oraz walidacji modeli wykorzystano rodzinę pakietów \textit{Tidymodels}, będą następcą popularnego pakietu \textit{Caret} i rozwijaną w ramach projektu \textit{Tidyverse}.

Drzewo decyzyjne oraz lasy losowe zostały poddane kalibracji z użyciem metody przeszukiwania zachłannego wszystkich kombinacji przestrzeni parametrów. Dobrano tak odpowiednio maksymalną parametry \textit{cost_complexity} i \textit{tree_depth} dla drzewa decyzyjnego oraz \textit{mtry} (maksymalna liczba zmiennych wykorzystywanych przy podziale węzła) i \textit{sample.fraction}. Model GBM został poddany jedynie eksperckiej kalibracji, ze względu na dużo bardziej skomplikowaną parametryzację i większe zapotrzebowanie na moc obliczeniową, utrudniające przeszukiwanie przestrzeni kombinacji parametrów.

Ogólne własności i obserwowane w zbiorze danych zostaną omówione na przykładzie uproszczonego drzewa decyzyjnego, ale w dalszej analizie będzie wykorzystywane już większe drzewo, o optymalnych dla analizowanego zbioru danych parametrach.

Podział na zbiór testowy i uczący dokanano losowo, przy czym 3/4 obserwacji przeznaczono na zbiór uczący. Tych samych zbiorów uczących i testowych używano następnie dla wszystkich analizowanych modeli, za wyjątkiem kalibracji parametrów, gdzie zostały wykorzystane niezależnie wylosowane podziały.

## Parametryzacja

Poniżej przedstawiono parametryzację wszystkich omawianych w dalszej części pracy modeli.

### Drzewo decyzyjne uproszczone

\begin{itemize}
  \item $cost\_complexity = 0.0005$ (parametr funkcji kary wykorzystywanej przy przycinaniu drzewa, im wyższa wartość tym mniejsze drzewo)
  \item $min\_n = 5$ (minimalna liczba obserwacji w liściu)
  \item $tree\_depth = 5$ (maksymalna głębokość drzewa)
\end{itemize}

### Drzewo decyzyjne pełne

\begin{itemize}
  \item $cost\_complexity = 0.00005$
  \item $min\_n = 5$
  \item $tree\_depth = 8$
\end{itemize}

### Lasy losowe

\begin{itemize}
  \item $mtry = 3$ (liczba losowych predyktorów wykorzystywanych przy każdym podziale drzewa)
  \item $trees = 1000$ (łączna liczba drzew)
  \item $min\_n = 5$
  \item $return = TRUE$ (losowanie ze zwracaniem)
  \item $sample.fraction = 0.7$ (stosunek liczby obserwacji na których uczone jest pojedyncze drzewo do liczebności całego zbioru uczącego)
\end{itemize}

### GBM

\begin{itemize}
  \item $mtry = 3$ (liczba losowych predyktorów wykorzystywanych przy każdym podziale drzewa)
  \item $trees = 1000$ (łączna liczba drzew)
  \item $min\_n = 5$
  \item $tree\_depth = DEFAULT$ 
  \item $learn\_rate = .1$ (stała uczenia)
  \item $loss\_reduction = DEFAULT$ (minimalny spadek funkcji kary przy którym dopuszczany jest kolejny podział)
  \item $sample\_size = 0.7$
\end{itemize}

\clearpage

## Wyniki

W niniejszym rozdziale zostaną omówione i porównane wyniki modeli.

### Reguły decyzyjne w modelu uproszczonym

Poniżej zostanie przeanalizowany model uproszczonego drzewa decyzyjnego:

```{r, echo=FALSE}
rpart.plot(tree_model_simple$fit, roundint = F)
```

Na powyższym wykresie można zauważyć 4 reguły decyzyjne dotyczące 5 lub więcej procent obserwacji w zbiorze uczącym:
\begin{enumerate}
  \item $69\% -$ osoby młody ($< 43$ lata) i korzystające z małej liczby produktów ($< 2.5$) nie zmieniają banku
  \item $7\% -$ aktywni klienci korzystający z 2 produktów nie zmieniają banku
  \item $7\% -$ aktywni klienci z poza Niemiec, korzystający z 1 produktu, nie zmieniają banku
  \item $5\% -$ aktywni klienci w podeszłym wieku ($\geq 74$ lata) zmieniają bank
\end{enumerate}

Wnioski z analizy powyższego drzewa mogą być zaskakujące. Okazuje się, że to właśnie osoby starsze częściej zmieniają dostawcę usług bankowych, podczas gdy intuicyjnie można przedstawić argumenty na poparcie przeciwnej tezy. Zmiennymi mającymi istotny wpływ na oszacowania modelu (decydują o podziałach które prowadzą do liści zawierających co najmniej 1\% zbioru uczącego) są tylko kraj pochodzenia, aktywność, wiek i liczba produktów (4 na 7). Płeć, ilość środków na końcie czy ocena wiarygodności kredytowej mają bardzo mały wpływ na decyzję klienta o zmianie dostawcy usług bankowych. Częstsze zmienianie banku przez ludzi młodych może wynikać z braku czasu i nie posiadania oszczędności, ale może być również wynikiem specyficznej polityki danego banku.

\clearpage

```{r,echo=FALSE}
bind_cols(
  test_dfs$tree,
  tree_model_simple %>% predict(test_dfs$tree, type = "class"),
  tree_model_simple %>% predict(test_dfs$tree, type = "prob")
) %>% metrics(Exited, .pred_class, .pred_No) %>% 
  dplyr::select(-2) %>%
  rename(`Miara dopasowania` = .metric, Oszacowanie = .estimate) %>% 
  mutate(Oszacowanie = round(Oszacowanie, 2)) %>% 
  kable("markdown")
```

Pomimo zastosowania pomniejszonego drzewa model gwarantuje skuteczną klasyfikację dla 85,3\% zbioru testowego, przy pozostałych wskaźnikach na również akceptowalnym poziomie. W dalszej części pracy zostanie przeanalizowane na ile te wyniki można poprawić.

### Porównanie metod klasyfikacji

