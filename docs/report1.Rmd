---
output:
  pdf_document:
    includes:
      in_header: "preamble.tex"
---

```{r, include=FALSE}

library(tidyverse)
library(stringr)
library(scorecard)
library(tidymodels)
library(ranger)
library(xgboost)
library(vip)
library(knitr)

rm(list = ls())

source("../funs_valid.R")
source("../funs_preproc.R")

ranger_models <- read_rds("../data/fitted_models.RDS")
xgboost_model <- read_rds("../data/fitted_xgboost.RDS")
df_preds_ranger <- read_rds("../data/predictions.RDS")
df_pred_xgboost <- read_rds("../data/predictions_xgboost.RDS")
df_1 <- read_rds("../data/split.RDS")$data
df_2 <- read_rds("../data/split_raw.RDS")$data

```

\begin{titlepage}

\begin{center}
\vspace*{0.5in}
\begin{figure}[htb]
\begin{center}
\includegraphics[width=7cm]{herbSGH.png}
\end{center}
\end{figure}
\vspace*{0.15in}
Indukowane Reguły Decyzyjne - 2020\\
\vspace*{0.05in}
SGH Warsaw School of Economics \\
\vspace*{0.5in}
\begin{large}
CHURN MODELLING \\
\end{large}
\vspace*{0.2in}
\begin{Large}
\textbf{Klasyfikacja klienta banku} \\
\end{Large}
\vspace*{0.5in}
\rule{80mm}{0.1mm}\\
\vspace*{0.1in}
\begin{large}
Przygotowane przez: \\
Jakub Cierocki \& Szymon Reddig \\
\end{large}
\end{center}
\end{titlepage}

\clearpage
\tableofcontents
\clearpage

## Wprowadzenie

Zjawisko tzw. ,,customer churn'' (ang. \textit{churn} - odpływ, rezygnacja), czyli rezygnacji klienta z subskrypcji usług danego przedsiębiorstwa, jest w kręgu zainteresowania naukowców od wielu lat.

Do modelowania churnu stosuje się m.in. metody analizy przetrwania (jak długo klient będzie odnawiał subskrybcję) oraz klasyfikacji binarnej (czy klient w niedługiej przyszłości zmieni dostawcę usług). W niniejszym raporcie zajmiemy się drugim z ww. zagadnień.

Firmy, a w szczególności telekomy, ubezpieczyciele oraz banki, inwestują w modelowanie tego zjawiska, gdyż pozyskiwanie nowych klientów jest często o wiele droższym zabiegiem, niż utrzymanie dotychczasowych, a dynamika ich liczby jest kluczowa przy modelowaniu procesów biznesowych. Przykładowo, jeśli Spotify (dostawca usługi streamowania muzyki) zidentyfikowałoby segment osób, które z dużym prawdopobieństwem zrezygnują niedługo z subskrypcji, przedsiębiorstwo mogłoby zasypać ich specjalnymi ofertami, zachęcających ich do dalszego korzystania z ich oferty. Z drugiej strony powiązanie nielojalności konsumenckiej z atrybutami konkretnej podgrupy klientów może pomóc w racjonalizacji kosztów przeznaczonych na reklamę i projektowanie produktów przeznaczonych dla jej przedstawicieli. W przypadku m.in. telekomów subskrypcje abonamentowe stanowią podstawowe źródło dochodów przedsiębiorstwa i ich odpowiednie prognozowanie ich dynamiki jest niezbędne w procesie prognozowania przychodów przedsiębiorstwa.

## Problem badawczy

Zjawisko ,,churnu'' będzie analizowane z perspektywy banku. Dysponuje on pewnymi danymi personalnymi swoich klientów oraz pełną informacją o ich aktualnej (i przeszłej) subskrypcji usług tego banku. Celem niniejszej pracy będzie zbadanie czy na podstawie tych danych bank jest w stanie przewidzieć przyszłe decyzje o rezygnacji z jego usług w niedalekiej (bliżej nie określonej) przyszłości.

## Zbiór danych

Zbiór danych wykorzystamy w niniejszej pochodzi z portalu kaggle.com, należącego do Google LLC i pełniącego rolę platformy wymiany myśli (w tym zbiorów danych) dla specjalistów i pasjonatów zajmujących się analizą danych. Zanonimizowane dane dotyczą 10 tys. klientów jednego z banków, operującego w 3 różnych krajach (Francja, Niemcy, Hiszpania).

Rolę atrybutu decyzyjnego będzie pełnić zmiennna binarna \textit{EXIT}, która przyjmuje wartość 1 jeżeli klient zrezygnował z usług danego banku. Odsetek klientów, którzy zmienili dostawcę usług bankowych wynosi w analizowanym zbiorze 20,37\%.

Wykorzystany zbiór deskryptorów liczy łącznie 10 zmiennych, które opisują cechy osobowe oraz historię relacji danego klienta z bankiem.

\begin{itemize}
  \item \textit{Geography} - kraj pochodzenia, zmienna kategoryzowana, skala nominalna
  \item \textit{Gender} - płeć, zmienna binarna, 1 - mężczyzna
  \item \textit{HasCrCard} - posiadanie karty kredytowej, zmienna binarna, 1 - posiada
  \item \textit{IsActiveMember} - bycie aktywnym klientem banku (korzystającym z subskrybowanych usług np. wykonującym przelewy), zmienna binarna, 1 - tak
  \item \textit{Age} - wiek, zmienna całkowitoliczbowa
  \item \textit{Balance} - ilość pieniędzy na koncie, zmienna liczbowa
  \item \textit{CreditScore} - ocena wiarygodności kredytowej, zmienna liczbowa
  \item \textit{NumOfProducts} - liczba subsrybowanych usług bankowych, zmienna całkowitoliczbowa
  \item \textit{EstimatedSalary} - przybliżone zarobki, zmienna liczbowa
  \item \textit{Tenure} - liczba lat odkąd klient zaczął korzystać z usług danego banku, zmienna całkowitoliczbowa
\end{itemize}

Surowy zbiór danych był już oczyszony i nie zawierał braków danych oraz zmiennych wymagających rekodowania. Dokonano konwersji typów na odpowiadające rzeczywistemu charakterowi zmiennych (liczbowe lub kategoryzowane). Kategoriom zmiennych jakościowych nadano odpowiednie etykiety. Zmienna \textit{Country} jako jedyna zmienna nominalna z liczbą kategorii $>2$ w zbiorze została przekonwertowana na dwie zmienne binarne \textit{CountryGermany} oraz \textit{CountrySpain}.

Zostały wyodrębione 2 warianty zbioru danych. Pierwszy, który dalej będzie nazywany surowym, zawiera dane uwzględniające tylko ww. przekształcenia. Drugi, które będzie dalej nazywany przekształconym, zawiera wszystkie zmienne ilościowe poddane kategoryzacji. Wykorzystano w tym celu pakiet \textit{scorecard} oraz algorytm wykorzystujące drzewa do dobrania optymalnego z punktu widzenia IV (ang. \textit{Information Value}) kategoryzacji zmiennej. W celu uniknięcia zaburzenia oceny istotności zmiennych w modelu na podstawie wskaźnika Giniego, maksymalna liczba kategorii została ustalona na poziomie 5. Już po konwersji, uzyskany zbiór danych przefiltrowano adrzucając zmienne, których IV było mniejsze od 0.01.

```{r, echo=FALSE}
get_all_iv(df_1, df_2) %>% 
  mutate_if(is.numeric, ~ round(.x, 2)) %>% 
  kable("markdown", col.names = c("Zmienna", "Surowy", "Przekształcony"))
```

IV są konsekwentnie wyższe dla danych nieprzekształconych, co wynika z faktu, że wskaźnik ten jest dodatnio skorelowany z liczbą kategorii. 

```{r, echo=FALSE, out.height='310px', fig.align='center'}
plot_multi_freq(df_1, c("Age", "Balance", "NumOfProducts"))
```

Jak widać na powyższym wykresie są obserwowane liniowe zależności między udziałem danej kategorii w liczbie obserwacji, a procentem rezygnujących klientów, dla zmiennych \textit{Balance} oraz \textit{NumOfProducts}. W przypadku zmiennej \textit{Age} wykres nie sugeruje takiej korelacji co budzi podejrzenia co do poprawności tej kategoryzacji.

## Metodologia

W pracy zostaną porównane 4 modele:
\beign{itemize}
  \item drzewo decyzyjne CART na danych surowych (pakiet \textit{rpart})
  \item las losowy na danych przekształconych (pakiet \textit{ranger})
  \item las losowy na danych surownych (pakiet \textit{ranger})
  \item GBM na danych przekształconych (pakiet \textit{XGBoost})
\end{itemize}

Drzewo decyzyjne na danych przekształconych pominięto ponieważ kategoryzacja zmiennych służy jedynie możliwości uzyskania nieobciążonych pomiarów istotności obliczanych z użyciem wskaźnika Giniego, a w przypadku pojedynczego drzewa mamy możliwość jego podejrzenia i co za tym idzie pełną interpretowalność zmiennych. GBM na danych surowych pominięto ponieważ API pakietu XGBoost nie pozwala na oszacowanie istotności zmiennych metodą permutacyjną przy trenowaniu modelu. W tej sytuacji, zastosowanie danych surowych spowodowałoby uzyskanie obciążonych pomiarów istotności zmiennych.

Do zarządzania podziałem zbiorów na testowy i uczący, określenia specyfikacji, trenowania oraz walidacji modeli wykorzystano rodzinę pakietów \textit{Tidymodels}, będą następcą popularnego pakietu \textit{Caret} i rozwijaną w ramach projektu \textit{Tidyverse}.

Drzewo decyzyjne oraz lasy losowe zostały poddane kalibracji z użyciem metody przeszukiwania zachłannego wszystkich kombinacji przestrzeni parametrów. Dobrano tak odpowiednio maksymalną parametry \textit{cost_complexity} i \textit{tree_depth} dla drzewa decyzyjnego oraz \textit{mtry} (maksymalna liczba zmiennych wykorzystywanych przy podziale węzła) i \textit{sample.fraction}. Model GBM został poddany jedynie eksperckiej kalibracji, ze względu na dużo bardziej skomplikowaną parametryzację i większe zapotrzebowanie na moc obliczeniową, utrudniające przeszukiwanie przestrzeni kombinacji parametrów.

Ogólne własności i obserwowane w zbiorze danych zostaną omówione na przykładzie uproszczonego drzewa decyzyjnego, ale w dalszej analizie będzie wykorzystywane już większe drzewo, o optymalnych dla analizowanego zbioru danych parametrach.

## Parametryzacja

Poniżej przedstawiono parametryzację wszystkich omawianych w dalszej części pracy modeli.

### Drzewo decyzyjne uproszczone

\begin{itemize}
  \item $cost_complexity = 0.00005$
  \item $min_n = 5$
  \item $tree_depth = 8$
\end{itemize}


